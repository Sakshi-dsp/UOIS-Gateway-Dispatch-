{
  "$id": "https://dispatch.arch/schemas/events/consumed/location/revalidation_found.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$comment": "NOTE: This schema is owned by Location Service. Canonical source: Location-Service-Dispatch-/Contracts/02_events/schemas/revalidation_found.json. This copy is maintained for Order Service validation. Must stay in sync with Location Service schema.",
  "title": "RevalidationFoundEvent",
  "description": "Event published by Location Service when serviceability revalidation completes. Used in /init revalidation flow (when time_elapsed > 1 minute). Order Service and Quote Service consume this event. Uses the same unified computation handler as ServiceabilityFoundEvent to ensure consistency.",
  "type": "object",
  "required": [
    "event_type",
    "event_id",
    "search_id",
    "distance_origin_to_destination",
    "eta_origin",
    "eta_destination",
    "bucket_counts",
    "serviceable",
    "traceparent",
    "timestamp"
  ],
  "properties": {
    "event_type": {
      "type": "string",
      "const": "REVALIDATION_FOUND",
      "description": "Event type discriminator. Always REVALIDATION_FOUND for /init revalidation flow."
    },
    "event_id": {
      "type": "string",
      "format": "uuid",
      "description": "Unique event identifier (UUID v4). REQUIRED. Generated by Location Service at publish time and reused across retries of the same publish attempt. Used for event-level deduplication, DLQ correlation, and reliable auditing. Consumers should store processed event_ids (e.g., in Redis with TTL) for at-least-once delivery deduplication."
    },
    "search_id": {
      "type": "string",
      "format": "uuid",
      "description": "Search session ID from original /search (UUID). Single source of truth for correlation. REQUIRED."
    },
    "distance_origin_to_destination": {
      "type": "number",
      "minimum": 0,
      "description": "OSRM route distance from pickup to drop (kilometers). REQUIRED."
    },
    "bucket_counts": {
      "type": "object",
      "required": ["D1", "D2", "D3", "D4", "D5"],
      "description": "Count of eligible riders in each distance bucket. REQUIRED for pricing supply scarcity calculation.",
      "properties": {
        "D1": {
          "type": "integer",
          "minimum": 0,
          "description": "Rider count within 500m radius"
        },
        "D2": {
          "type": "integer",
          "minimum": 0,
          "description": "Rider count within 1000m radius"
        },
        "D3": {
          "type": "integer",
          "minimum": 0,
          "description": "Rider count within 2000m radius"
        },
        "D4": {
          "type": "integer",
          "minimum": 0,
          "description": "Rider count within 3000m radius"
        },
        "D5": {
          "type": "integer",
          "minimum": 0,
          "description": "Rider count within 5000m radius"
        }
      },
      "additionalProperties": false
    },
    "eta_origin": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp - ETA for rider to reach pickup. REQUIRED. Computed from nearest collected riders."
    },
    "eta_destination": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp - ETA for delivery completion. REQUIRED. Computed as eta_origin + travel time for distance_origin_to_destination."
    },
    "serviceable": {
      "type": "boolean",
      "description": "Whether the location pair is serviceable (has available riders within acceptable distance). REQUIRED. Quote Service should skip pricing if false."
    },
    "closest_bucket": {
      "type": "string",
      "enum": ["D1", "D2", "D3", "D4", "D5"],
      "description": "Smallest radius bucket with riders. Optional, used for reporting/product tier display only."
    },
    "service_type": {
      "type": "string",
      "enum": ["ECOM", "STANDARD", "INSTANT"],
      "description": "Service type requested. Optional but helpful. Defaults to STANDARD if not provided."
    },
    "client_id": {
      "type": ["string", "null"],
      "format": "uuid",
      "description": "Client identifier for client-specific serviceability rules. Optional but helpful for pricing config lookup."
    },
    "payment_type": {
      "type": ["string", "null"],
      "description": "Payment type (e.g., PREPAID, COD). Optional but helpful."
    },
    "origin_timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp when the original /search request was initiated. Optional but helpful for stale request detection."
    },
    "traceparent": {
      "type": "string",
      "pattern": "^00-[0-9a-f]{32}-[0-9a-f]{16}-[0-9a-f]{2}$",
      "description": "W3C traceparent header for distributed tracing (format: 00-<trace-id>-<span-id>-<flags>). REQUIRED for end-to-end observability. Generated by UOIS Gateway at edge, propagated through all services and events. Services extract traceparent and create child spans (do not generate new trace IDs)."
    },
    "trace_id": {
      "type": "string",
      "pattern": "^[0-9a-f]{32}$",
      "description": "Distributed tracing identifier (extracted from traceparent for convenience). Optional but RECOMMENDED. Propagated from UOIS Gateway. Used for logging and correlation alongside search_id."
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp when computation completed. REQUIRED."
    },
    "metadata": {
      "type": "object",
      "additionalProperties": true,
      "description": "Optional computation metadata (for debugging)",
      "properties": {
        "riders_collected": {
          "type": "integer",
          "minimum": 0,
          "maximum": 10,
          "description": "Number of rider candidates collected (internal use)"
        },
        "query_time_ms": {
          "type": "integer",
          "minimum": 0,
          "description": "Query execution time in milliseconds"
        },
        "early_termination": {
          "type": "boolean",
          "description": "Whether early termination was triggered"
        }
      }
    }
  },
  "additionalProperties": false
}
