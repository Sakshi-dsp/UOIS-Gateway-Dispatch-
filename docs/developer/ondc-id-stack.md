# ONDC ID Stack Architecture - Developer Documentation

**Service:** UOIS Gateway (Seller NP - Logistics / P2P)  
**Status:** ✅ Certification-Safe Architecture  
**Last Updated:** January 2025

---

## Overview

This document defines the **final, clean ID stack** with **strict ONDC boundaries** for the Seller NP (BPP/LSP) implementation. This architecture ensures certification compliance by maintaining clear separation between ONDC-visible IDs and internal-only identifiers.

**Key Principle:** ONDC provides exactly ONE guaranteed correlation ID at a time. Authority is handed off cleanly: `search_id → quote.id → order.id`. Everything else is internal.

---

## Architecture

### Design Pattern
- **Boundary Separation**: Strict separation between ONDC-visible and internal-only IDs
- **Single Source of Truth**: One active ID per phase
- **Echo Guarantees**: Buyer must echo certain IDs for correlation
- **No Tag-Based Correlation**: Tags must NOT be used for correlation

### ID Categories

#### ONDC-Exposed (Protocol IDs)
These IDs appear on the ONDC protocol wire and are visible to the Buyer NP:

- **`provider.id`** - Catalog provider identifier (STABLE)
- **`item.id`** - Service item identifier (STABLE)
- **`quote.id`** - Transaction commitment identifier (EPHEMERAL)
- **`order.id`** - Network order identity (EPHEMERAL) → **Internally named `client_order_id`**

#### Internal-Only (Never on Wire)
These IDs never leave the Seller NP and are used for internal correlation:

- **`search_id`** - Serviceability correlation identifier
- **`dispatch_order_id`** - Execution / rider operations identifier (separate from `client_order_id`)

### Critical Naming Convention

**ONDC `message.order.id` = `client_order_id` (Internal Naming)**

Inside internal services, ONDC `order.id` should be treated as `client_order_id`:
- This is the **Seller-generated order reference** (client-facing business order ID)
- **Seller ALWAYS generates** `order.id` in `/on_confirm` response
- **Buyer NEVER provides** `order.id` in `/confirm` request
- Buyer uses this ID in `/status`, `/track`, `/cancel`, `/update` (post-order APIs)
- Seller must **echo it unchanged** in responses
- **DO NOT** rename it to `dispatch_order_id` internally

**`dispatch_order_id` is a separate internal execution ID:**
- Generated by Seller NP for execution systems
- Used for rider assignment, state machine, fulfillment, ops dashboards
- **Never** goes on ONDC wire
- **Never** expected to be echoed by Buyer
- **Coexists** with `client_order_id`, never replaces it

---

## ID Mapping Table (Authoritative)

| Concept            | ONDC Field               | Internal Name       | Owner  | Visibility    | Purpose |
| ------------------ | ------------------------ | ------------------- | ------ | ------------- | ------- |
| Quote ID           | `message.order.quote.id` | `quote_id`          | Seller | ONDC-visible  | Transaction commitment identifier |
| Order ID           | `message.order.id`       | `client_order_id`   | **Seller** | ONDC-visible  | Seller-generated order reference (buyer uses post-order) |
| Execution Order ID | ❌                        | `dispatch_order_id` | Seller | Internal-only | Internal execution handle (rider ops, fulfillment) |

**Key Points:**
- ONDC `order.id` = `client_order_id` internally (**Seller-generated**, buyer uses in post-order APIs)
- `dispatch_order_id` is a **separate** internal execution ID (never on wire)
- These IDs **coexist**, never replace each other

---

## ID Boundary Diagram

```
┌──────────────────────────────────────────────────────────────┐
│                      BUYER NP (BAP)                           │
│                                                              │
│  /search                                                     │
│    └─ intent only                                            │
│                                                              │
│  /init                                                       │
│    └─ echoes provider.id + item.id                           │
│                                                              │
│  /confirm                                                    │
│    └─ echoes quote.id                                        │
│                                                              │
│  /status /track /cancel /update                              │
│    └─ uses order.id                                          │
│                                                              │
└───────────────▲──────────────────────────────────────────────┘
                │  (ONDC Protocol Boundary)
                │
┌───────────────┴──────────────────────────────────────────────┐
│                 SELLER NP (BPP / LSP)                         │
│                                                              │
│  INTERNAL ONLY (never on wire)                                │
│  ────────────────────────────────────────────               │
│   search_id            ← serviceability correlation           │
│   dispatch_order_id    ← execution / rider ops                │
│                                                              │
│  ONDC-EXPOSED (protocol IDs)                                  │
│  ────────────────────────────────────────────               │
│   provider.id   ← catalog provider (STABLE)                  │
│   item.id       ← service item (STABLE)                      │
│   quote.id      ← transaction commitment (EPHEMERAL)         │
│   order.id      ← client_order_id (business reference)        │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

---

## ID Lifecycle Flow

### Step-by-Step Flow

```
/search
  └─ generate search_id (INTERNAL ONLY)

/on_search
  └─ send provider.id + item.id
     (no correlation guarantee)

/init
  └─ buyer echoes provider.id + item.id

/on_init
  └─ generate quote.id
     └─ map quote.id → search_id (internal)

/confirm
  └─ buyer echoes quote.id
  └─ validate quote
  └─ generate:
        client_order_id (SELLER-GENERATED ONDC order.id)
        dispatch_order_id (internal, separate execution ID)

/on_confirm
  └─ send order.id (client_order_id, seller-generated)

/post-order APIs
  └─ buyer uses order.id (client_order_id)
  └─ map client_order_id → dispatch_order_id (internal)
```

---

## Single Source of Truth Per Phase

| Phase      | Active ID             | Scope    | Echo Guaranteed | Description |
| ---------- | --------------------- | -------- | --------------- | ----------- |
| Search     | search_id             | Internal | ❌               | Generated internally, never exposed |
| Catalog    | provider.id           | ONDC     | ⚠️              | Sent in /on_search, echoed in /init |
| Init       | provider.id + item.id | ONDC     | ⚠️              | Echoed in /init, not guaranteed beyond selection phase |
| Quote      | quote.id              | ONDC     | ✅               | Buyer MUST echo in /confirm |
| Confirm    | quote.id              | ONDC     | ✅               | Used for validation |
| Post-order | order.id              | ONDC     | ✅               | Buyer uses for all post-order APIs |
| Execution  | dispatch_order_id     | Internal | ❌               | Internal execution tracking |

**Legend:**
- ✅ **Echo Guaranteed**: Buyer MUST send back this ID
- ⚠️ **Echo in Init**: Buyer echoes in `/init`, but ONDC does not guarantee persistence beyond selection phase
- ❌ **No Echo**: Internal-only, never on wire

---

## Hard Boundary Rules

### ❌ DO NOT BREAK

1. **`search_id` never leaves Seller NP**
   - Internal correlation only
   - Never included in ONDC protocol messages
   - Used for mapping to serviceability events

2. **`dispatch_order_id` never leaves Seller NP**
   - Internal execution tracking only
   - Never included in ONDC protocol messages
   - Used for rider operations and dispatch management

3. **`provider.id` must NEVER be per-request**
   - Must be STABLE across requests
   - Represents the catalog provider identity
   - Should be configured, not generated

4. **`quote.id` must NEVER be reused**
   - EPHEMERAL identifier
   - One quote.id per transaction
   - Must be unique and non-reusable

5. **Tags must NOT be used for correlation**
   - ONDC tags are for metadata only
   - Do not rely on tags for ID correlation
   - Use proper protocol IDs for correlation

6. **`client_order_id` and `dispatch_order_id` must NEVER be confused**
   - ONDC `order.id` = `client_order_id` (client-facing business reference)
   - `dispatch_order_id` = internal execution handle (separate ID)
   - They coexist, never replace each other
   - Do NOT rename ONDC `order.id` to `dispatch_order_id`
   - Do NOT expect Buyer to echo `dispatch_order_id`

---

## Implementation Guidelines

### ID Generation

#### Internal IDs
```go
// search_id generation
searchID := generateUUIDv4() // UUID v4 (random) for certification clarity

// dispatch_order_id generation
dispatchOrderID := generateUUIDv4() // UUID v4 (random) for certification clarity
```

#### ONDC Protocol IDs
```go
// provider.id - STABLE (from config/catalog)
providerID := config.GetProviderID() // Must be stable

// item.id - STABLE (from catalog)
itemID := catalogItem.ID // Must be stable

// quote.id - EPHEMERAL (generated per transaction)
quoteID := generateUUIDv4() // UUID v4 (random), must be unique, never reused

// order.id (client_order_id) - EPHEMERAL (SELLER-GENERATED in /on_confirm)
// Buyer NEVER provides order.id in /confirm request
clientOrderID := generateUUIDv4() // UUID v4 (random), must be unique, seller-generated
```

**Note:** UUID v4 (random) is recommended for certification clarity to avoid any reviewer questions about predictability.

### ID Mapping

#### Internal Mapping Structure
```go
type IDMapping struct {
    SearchID        string // Internal: serviceability correlation
    ProviderID      string // ONDC: stable catalog provider
    ItemID          string // ONDC: stable service item
    QuoteID         string // ONDC: ephemeral quote identifier
    ClientOrderID   string // ONDC: order.id (client-facing business reference)
    DispatchOrderID string // Internal: execution tracking (separate from client_order_id)
}
```

#### Mapping Operations

**Phase 1: Search → Init**
```go
// Store mapping: search_id → provider.id + item.id
storeMapping(searchID, providerID, itemID)
```

**Phase 2: Init → Quote**
```go
// Generate quote.id and map to search_id
quoteID := generateQuoteID()
mapQuoteToSearch(quoteID, searchID)
```

**Phase 3: Confirm → Order**
```go
// Validate quote.id
validateQuote(quoteID)

// Seller ALWAYS generates ONDC order.id (client_order_id)
// Buyer NEVER provides order.id in /confirm request
clientOrderID := generateUUIDv4()

// Generate separate dispatch_order_id for internal execution
dispatchOrderID := generateDispatchOrderID()

// Store mappings
mapClientOrderToQuote(clientOrderID, quoteID)
mapClientOrderToDispatch(clientOrderID, dispatchOrderID)
```

---

## Validation Checklist

### `/confirm` Validation

When receiving `/confirm` with `quote.id`:

1. ✅ **Quote ID Validation**
   - Verify `quote.id` exists in system
   - Check quote is still valid (not expired)
   - Ensure quote has not been used before

2. ✅ **Quote-to-Search Mapping**
   - Retrieve `search_id` from `quote.id` mapping
   - Verify search context is still valid

3. ✅ **ID Generation**
   - **Seller ALWAYS generates** `client_order_id` (ONDC `order.id`) - never reuse
   - **Buyer NEVER provides** `order.id` in `/confirm` request
   - Generate unique `dispatch_order_id` (internal, separate execution ID)
   - Store all mappings: `client_order_id` ↔ `dispatch_order_id`

4. ✅ **Response**
   - Return `order.id` (`client_order_id`) in `/on_confirm`
   - Never expose `dispatch_order_id` or `search_id`

### Post-Order API Validation

When receiving post-order APIs (`/status`, `/track`, `/cancel`, `/update`) with `order.id`:

1. ✅ **Order ID Validation**
   - Verify `order.id` (`client_order_id`) exists in system
   - Check order is in valid state for operation

2. ✅ **Internal Mapping**
   - Retrieve `dispatch_order_id` from `client_order_id` mapping
   - Use `dispatch_order_id` for internal operations (Order Service, Dispatch Service)
   - Order Service never sees `client_order_id` directly - only `dispatch_order_id`

3. ✅ **Response**
   - Never expose `dispatch_order_id` in responses
   - Use `order.id` (`client_order_id`) for all ONDC protocol responses

---

## Logging and Auditing

### Logging Guidelines

**✅ DO:**
- Log internal IDs (`search_id`, `dispatch_order_id`) in internal logs
- Log ONDC IDs (`quote.id`, `order.id` as `client_order_id`) in protocol logs
- Include correlation mappings in audit logs: `client_order_id` ↔ `dispatch_order_id`

**❌ DON'T:**
- Never log internal IDs in ONDC protocol responses
- Never expose internal IDs in error messages sent to Buyer NP
- Never include internal IDs in metrics exposed externally

### Audit Trail

```go
// Internal audit log structure
type AuditLog struct {
    Timestamp        time.Time
    Event            string // "search", "init", "confirm", etc.
    ONDCQuoteID      string // ONDC-visible
    ClientOrderID    string // ONDC-visible (order.id from protocol)
    InternalSearchID string // Internal-only
    DispatchOrderID  string // Internal-only (execution ID)
}
```

### Logging Example

```go
// Log with proper ID separation
logger.Info("Order confirmed",
    zap.String("client_order_id", clientOrderID),   // ONDC-visible (order.id)
    zap.String("dispatch_order_id", dispatchOrderID), // Internal-only (not in response)
    zap.String("quote.id", quoteID),                // ONDC-visible
)
```

---

## Database Schema Suggestions

### ID Mapping Table

```sql
CREATE TABLE id_mappings (
    id BIGSERIAL PRIMARY KEY,
    search_id VARCHAR(255) NOT NULL,
    provider_id VARCHAR(255) NOT NULL,
    item_id VARCHAR(255) NOT NULL,
    quote_id VARCHAR(255) UNIQUE,
    client_order_id VARCHAR(255) UNIQUE NOT NULL, -- ONDC order.id
    dispatch_order_id VARCHAR(255) NOT NULL,     -- Internal execution ID
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
    
    INDEX idx_quote_id (quote_id),
    INDEX idx_client_order_id (client_order_id),
    INDEX idx_search_id (search_id),
    INDEX idx_dispatch_order_id (dispatch_order_id)
);
```

### Quote Table

```sql
CREATE TABLE quotes (
    id BIGSERIAL PRIMARY KEY,
    quote_id VARCHAR(255) UNIQUE NOT NULL,
    search_id VARCHAR(255) NOT NULL,
    provider_id VARCHAR(255) NOT NULL,
    item_id VARCHAR(255) NOT NULL,
    price DECIMAL(10,2) NOT NULL,
    currency VARCHAR(3) NOT NULL,
    expires_at TIMESTAMP NOT NULL,
    used BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    
    INDEX idx_quote_id (quote_id),
    INDEX idx_search_id (search_id),
    INDEX idx_expires_at (expires_at)
);
```

### Order Table

```sql
CREATE TABLE orders (
    id BIGSERIAL PRIMARY KEY,
    client_order_id VARCHAR(255) UNIQUE NOT NULL, -- ONDC order.id
    quote_id VARCHAR(255) NOT NULL,
    dispatch_order_id VARCHAR(255) NOT NULL,      -- Internal execution ID
    status VARCHAR(50) NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
    
    INDEX idx_client_order_id (client_order_id),
    INDEX idx_quote_id (quote_id),
    INDEX idx_dispatch_order_id (dispatch_order_id),
    INDEX idx_status (status)
);
```

---

## Error Handling

### ID-Related Errors

| Error Scenario | HTTP Status | Internal Code | ONDC Wire Code | Description |
| -------------- | ----------- | ------------- | -------------- | ----------- |
| Invalid quote.id | 400 | 30001 | 65001 | Quote ID not found or expired |
| Quote already used | 400 | 30002 | 65002 | Quote ID has already been used |
| Invalid order.id | 400 | 30003 | 65003 | Order ID not found |
| Missing provider.id | 400 | 30004 | 65004 | Provider ID missing in request |
| Missing item.id | 400 | 30005 | 65005 | Item ID missing in request |

**Error Code Mapping:**
- **Internal Codes (300xx)**: Used for internal logging, monitoring, and debugging
- **ONDC Wire Codes (6500x)**: Used in ONDC protocol error responses sent to Buyer NP
- If errors are internal-only (never sent to Buyer NP), internal codes are sufficient
- If errors go on the ONDC wire, map them to ONDC-standard error codes (6500x series)

### Error Response Format

**Internal Error (for logging):**
```go
// Internal error with code 30001
domainError := errors.NewDomainError(30001, "Invalid quote ID")
```

**ONDC Protocol Error (sent to Buyer NP):**
```json
{
  "error": {
    "code": "65001",
    "message": "Invalid quote ID",
    "type": "ONDC_ERROR"
  }
}
```

**Important:** 
- Never include internal IDs (`search_id`, `dispatch_order_id`) in error responses
- Map internal error codes to ONDC-standard codes when sending errors on the wire

---

## Testing

### Test Scenarios

1. **ID Generation Tests**
   - Verify `quote.id` is unique and non-reusable
   - Verify `client_order_id` (ONDC `order.id`) is unique
   - Verify `dispatch_order_id` is unique and separate from `client_order_id`
   - Verify internal IDs are never exposed

2. **ID Mapping Tests**
   - Verify `search_id` → `quote.id` mapping
   - Verify `quote.id` → `client_order_id` mapping
   - Verify `client_order_id` → `dispatch_order_id` mapping
   - Verify `client_order_id` and `dispatch_order_id` coexist (never replace each other)

3. **Boundary Tests**
   - Verify internal IDs never appear in ONDC responses
   - Verify ONDC IDs are properly echoed
   - Verify quote validation works correctly

4. **Correlation Tests**
   - Verify buyer echo of `provider.id` + `item.id` in `/init`
   - Verify buyer echo of `quote.id` in `/confirm`
   - Verify buyer use of `order.id` (`client_order_id`) in post-order APIs
   - Verify `dispatch_order_id` is never sent to or expected from Buyer

### Mock Data

```go
// Test constants
const (
    TestProviderID      = "provider-123"      // STABLE
    TestItemID          = "item-456"          // STABLE
    TestSearchID        = "search-789"        // Internal
    TestQuoteID         = "quote-abc"         // EPHEMERAL
    TestClientOrderID   = "OND-ORD-123"        // EPHEMERAL (ONDC order.id)
    TestDispatchOrderID = "DSP-00004567"       // Internal (separate execution ID)
)
```

---

## Production Considerations

### ✅ Certification Compliance

This architecture is **certification-safe** because:

1. **Clear Boundaries**: Strict separation between ONDC and internal IDs
2. **No Assumptions**: No reliance on tags or non-guaranteed correlations
3. **Proper Echo Handling**: Correct handling of buyer echo requirements
4. **ID Uniqueness**: Proper generation of ephemeral IDs

### Performance

- **ID Generation**: Use UUID v4 (random) for certification clarity and predictability avoidance
- **Mapping Lookups**: Index all ID columns for fast lookups
- **Cache Strategy**: Cache active quote-to-order mappings (with TTL)

### Monitoring

- Track quote ID reuse attempts (should never happen)
- Monitor `client_order_id` lookup failures
- Alert on missing ID mappings (`client_order_id` ↔ `dispatch_order_id`)
- Track ID generation performance
- Verify `client_order_id` and `dispatch_order_id` are never confused

---

## Related Files

- **Implementation**: `internal/handlers/ondc/` (search, init, confirm, status handlers)
- **Services**: `internal/services/` (quote service, order service)
- **Models**: `internal/models/` (ID mapping structures)
- **Config**: `internal/config/config.go` (provider.id configuration)

---

## Summary

**What It Does:**
- Defines clean ID boundaries between ONDC protocol and internal systems
- Ensures certification compliance with strict ID separation
- Provides single source of truth per transaction phase
- Maintains proper correlation without relying on tags

**Key Features:**
- ✅ Strict ONDC boundary enforcement
- ✅ Internal-only IDs never exposed
- ✅ Proper echo handling for guaranteed correlation
- ✅ Ephemeral IDs never reused
- ✅ Certification-safe architecture

**Production Status:** ✅ Ready for certification

---

## Mental Model

> **ONDC gives you exactly ONE guaranteed correlation ID at a time.**
> Ownership transitions cleanly:
>
> `search_id → quote.id → order.id (client_order_id, seller-generated)`
>
> * `search_id` → internal only
> * `quote.id` → buyer echoes in `/confirm`
> * `order.id` → **seller-generated**, buyer uses post-order
> * `dispatch_order_id` → internal execution only

### One-Line Sanity Check

If someone asks: "What ID do I use at this point in the flow?"

Answer in **one word** every time:
- `/search` → *internal* (`search_id`)
- `/init` → *provider/item* (`provider.id` + `item.id`)
- `/confirm` → *quote.id*
- Post-order → *client_order_id* (`order.id`)

### Critical Rule

> **ONDC `order.id` = `client_order_id` (seller-generated business reference)**  
> **`dispatch_order_id` = internal execution handle**

They **coexist**, never replace each other.

### Final ID Ownership Table (No Ambiguity)

| ID                           | Generated By | Visible To Buyer | Echoed By Buyer |
| ---------------------------- | ------------ | ---------------- | --------------- |
| search_id                    | Seller       | ❌                | ❌               |
| provider.id                  | Seller       | ✅                | `/init`         |
| item.id                      | Seller       | ✅                | `/init`         |
| quote.id                     | Seller       | ✅                | `/confirm`      |
| order.id (`client_order_id`) | **Seller**   | ✅                | Post-order APIs |
| dispatch_order_id            | Seller       | ❌                | ❌               |

**Protocol Truth:**
- `/confirm` request from Buyer contains: `message.order.quote.id` ✅
- `/on_confirm` response from Seller contains: `message.order.id` ✅ (**SELLER-GENERATED**)
- Buyer **cannot** invent or pre-send `order.id`

This diagram is **certification-safe**, **architecture-clean**, and **future-proof**.

