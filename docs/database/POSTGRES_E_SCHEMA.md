# UOIS Gateway - Postgres-E Database Schema Documentation

**Database Instance:** PostgreSQL-E (Audit Database) - Separate Database Instance  
**Purpose:** Immutable audit logs, order references, request/response pairs, client registry  
**Retention:** 7 years minimum (audit logs), 30 days (temporary references)  
**Access Pattern:** Write-only for logs (immutable), read for dispute resolution

---

## Schema Overview

The UOIS Gateway Postgres-E database consists of three schemas:

1. **`audit`** - Audit logging for request/response pairs and callback deliveries
2. **`client_registry`** - Local projection of client credentials (synced via events from Admin Service)
3. **`ondc_reference`** - Order reference mappings (currently used for DB storage, code uses Redis for hot-path)

---

## 1. Audit Schema (`audit`)

### 1.1 `audit.request_response_logs`

**Purpose:** Complete audit trail for all ONDC requests and responses (7-year retention for dispute resolution)

**Table Definition:**
```sql
CREATE SCHEMA IF NOT EXISTS audit;

CREATE TABLE IF NOT EXISTS audit.request_response_logs (
    request_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    transaction_id VARCHAR(255),
    message_id VARCHAR(255),
    action VARCHAR(50) NOT NULL,
    request_payload JSONB NOT NULL,
    ack_payload JSONB,
    callback_payload JSONB,
    trace_id VARCHAR(255),
    client_id VARCHAR(255),
    search_id UUID,
    quote_id UUID,
    order_id VARCHAR(255),
    dispatch_order_id VARCHAR(255),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);
```

**Field Descriptions:**

| Field | Type | Nullable | Description |
|-------|------|----------|-------------|
| `request_id` | UUID | NOT NULL | Primary key, unique identifier for each request/response log entry (auto-generated) |
| `transaction_id` | VARCHAR(255) | NULL | ONDC transaction ID from request context (for callback correlation) |
| `message_id` | VARCHAR(255) | NULL | ONDC message ID from request context (for callback correlation) |
| `action` | VARCHAR(50) | NOT NULL | ONDC action (e.g., "search", "init", "confirm", "status", "track", "cancel", "update", "rto", "issue", "issue_status") |
| `request_payload` | JSONB | NOT NULL | **Original request payload** in client's format (ONDC/Beckn) - stored as JSONB for flexible schema |
| `ack_payload` | JSONB | NULL | ACK/NACK response payload (synchronous HTTP 200 response) |
| `callback_payload` | JSONB | NULL | Callback response payload (asynchronous `/on_*` callback) - populated when callback is sent |
| `trace_id` | VARCHAR(255) | NULL | Distributed tracing identifier (extracted from W3C traceparent header) - used for end-to-end correlation |
| `client_id` | VARCHAR(255) | NULL | Client identifier (extracted from authentication context) |
| `search_id` | UUID | NULL | Serviceability ID (generated by UOIS Gateway during `/search` flow) - for `/search` and `/init` correlation |
| `quote_id` | UUID | NULL | Quote ID (generated by Order Service during `/init` flow) - for `/init` and `/confirm` correlation |
| `order_id` | VARCHAR(255) | NULL | ONDC order.id (seller-generated, network-facing) - sent in `/on_confirm` callback |
| `dispatch_order_id` | VARCHAR(255) | NULL | Internal Order Service identifier (internal-only, never sent in ONDC payloads) |
| `created_at` | TIMESTAMP | NOT NULL | Timestamp when log entry was created (immutable, set by database DEFAULT) |

**Indexes:**
```sql
CREATE INDEX IF NOT EXISTS idx_request_response_logs_transaction_id ON audit.request_response_logs(transaction_id);
CREATE INDEX IF NOT EXISTS idx_request_response_logs_message_id ON audit.request_response_logs(message_id);
CREATE INDEX IF NOT EXISTS idx_request_response_logs_client_id ON audit.request_response_logs(client_id);
CREATE INDEX IF NOT EXISTS idx_request_response_logs_trace_id ON audit.request_response_logs(trace_id);
CREATE INDEX IF NOT EXISTS idx_request_response_logs_search_id ON audit.request_response_logs(search_id);
CREATE INDEX IF NOT EXISTS idx_request_response_logs_quote_id ON audit.request_response_logs(quote_id);
CREATE INDEX IF NOT EXISTS idx_request_response_logs_order_id ON audit.request_response_logs(order_id);
CREATE INDEX IF NOT EXISTS idx_request_response_logs_created_at ON audit.request_response_logs(created_at);
```

**Usage Pattern:**
- **Write:** All ONDC handlers log request/response pairs after processing
- **Read:** Admin Dashboard (dispute resolution), Analytics Service (metrics)
- **Retention:** 7 years minimum (per regulatory requirements)
- **Immutability:** Append-only (no updates/deletes) - database constraints prevent modification

**JSONB Columns:**
- `request_payload` and `response_payload` use JSONB to store **original formats** (ONDC/Beckn)
- No schema changes needed when adding new client formats
- Supports querying with PostgreSQL JSONB operators
- Can create GIN indexes on frequently queried JSON paths

**Note on Missing Fields (FR vs Implementation):**
The FR document (Section 10.3) mentions additional fields that are **not currently implemented**:
- `request_hash` (SHA-256 of canonical request) - **Not implemented**
- `signature` (HMAC-SHA256 for non-repudiation) - **Not implemented**
- `nonce` (UUID for replay prevention) - **Not implemented**
- `source_ip` (client IP address) - **Not implemented**
- `protocol_type` (enum: 'ONDC', 'BECKN') - **Not implemented**
- `status_code` (HTTP status) - **Not implemented**
- `error_code` (if applicable) - **Not implemented**
- `scopes_evaluated` (array of strings) - **Not implemented**
- `environment` (sandbox/production) - **Not implemented**
- `traceparent` (W3C traceparent header) - **Not implemented** (only `trace_id` extracted from traceparent is stored)
- `bap_uri` (Buyer NP URI for callback URL construction) - **Not implemented**

These fields may be added in future migrations if required for compliance or enhanced audit capabilities.

---

### 1.2 `audit.callback_delivery_logs`

**Purpose:** Audit trail for callback delivery attempts (retry tracking, failure analysis)

**Table Definition:**
```sql
CREATE TABLE IF NOT EXISTS audit.callback_delivery_logs (
    request_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    callback_url TEXT NOT NULL,
    attempt_no INTEGER NOT NULL DEFAULT 1,
    status VARCHAR(50) NOT NULL,
    error TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);
```

**Field Descriptions:**

| Field | Type | Nullable | Description |
|-------|------|----------|-------------|
| `request_id` | UUID | NOT NULL | Primary key, unique identifier for each callback delivery log entry (auto-generated) |
| `callback_url` | TEXT | NOT NULL | Destination callback URL (e.g., `{bap_uri}/on_search`, `{bap_uri}/on_init`) |
| `attempt_no` | INTEGER | NOT NULL | Delivery attempt number (1, 2, 3, ...) - caller must guarantee monotonic attempt numbers |
| `status` | VARCHAR(50) | NOT NULL | Delivery status (e.g., "success", "failed", "retrying") |
| `error` | TEXT | NULL | Error message if delivery failed (NULL if successful) |
| `created_at` | TIMESTAMP | NOT NULL | Timestamp when log entry was created (immutable, set by database DEFAULT) |

**Indexes:**
```sql
CREATE INDEX IF NOT EXISTS idx_callback_delivery_logs_request_id ON audit.callback_delivery_logs(request_id);
CREATE INDEX IF NOT EXISTS idx_callback_delivery_logs_status ON audit.callback_delivery_logs(status);
CREATE INDEX IF NOT EXISTS idx_callback_delivery_logs_created_at ON audit.callback_delivery_logs(created_at);
```

**Usage Pattern:**
- **Write:** Callback service logs each delivery attempt (success/failure)
- **Read:** Analytics Service (callback success rate metrics), troubleshooting failed deliveries
- **Retention:** 7 years minimum (per regulatory requirements)
- **Immutability:** Append-only (no updates/deletes)

**Note on Missing Fields (FR vs Implementation):**
The FR document (Section 10.3.1) mentions additional fields that are **not currently implemented**:
- `webhook_id` (PK, UUID) - **Not implemented** (using `request_id` as PK instead)
- `webhook_url` (destination URL) - **Not implemented** (using `callback_url` instead)
- `response_code` (HTTP status from client) - **Not implemented**
- `response_body` (JSONB, if applicable) - **Not implemented**
- `retry_count` (integer) - **Not implemented** (using `attempt_no` instead)
- `next_retry_at` (timestamp) - **Not implemented**
- `delivered_at` (timestamp) - **Not implemented**
- `failure_reason` (text) - **Not implemented** (using `error` field instead)

These fields may be added in future migrations if required for enhanced callback delivery tracking.

---

## 2. Client Registry Schema (`client_registry`)

### 2.1 `client_registry.clients`

**Purpose:** Local projection of client credentials for runtime validation (synced via events from Admin Service)

**Table Definition:**
```sql
CREATE SCHEMA IF NOT EXISTS client_registry;

CREATE TABLE IF NOT EXISTS client_registry.clients (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    client_id UUID NOT NULL UNIQUE,
    client_code VARCHAR(50) NOT NULL,
    client_secret_hash TEXT NOT NULL,
    api_key_hash TEXT,
    bap_id VARCHAR(255),
    bap_uri TEXT,
    allowed_ips CIDR[],
    rate_limit INTEGER DEFAULT 100,
    status VARCHAR(20) NOT NULL DEFAULT 'ACTIVE',
    metadata JSONB,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    last_synced_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);
```

**Field Descriptions:**

| Field | Type | Nullable | Description |
|-------|------|----------|-------------|
| `id` | UUID | NOT NULL | Primary key, internal database identifier (auto-generated) |
| `client_id` | UUID | NOT NULL | Client identifier (from Admin Service) - UNIQUE constraint, used for lookups |
| `client_code` | VARCHAR(50) | NOT NULL | Human-readable client code (e.g., "ACME_CORP") |
| `client_secret_hash` | TEXT | NOT NULL | Bcrypt/Argon2 hash of client secret (for credential validation) |
| `api_key_hash` | TEXT | NULL | Alias for `client_secret_hash` (ONDC terminology) - synced from Admin Service events |
| `bap_id` | VARCHAR(255) | NULL | ONDC Buyer App Provider ID (extracted from metadata) |
| `bap_uri` | TEXT | NULL | ONDC Buyer App Provider URI for callbacks (extracted from metadata) |
| `allowed_ips` | CIDR[] | NULL | Array of CIDR ranges for IP allowlisting (empty array = no restrictions) |
| `rate_limit` | INTEGER | NULL | Requests per window (default: 100) - extracted from metadata |
| `status` | VARCHAR(20) | NOT NULL | Client status: 'ACTIVE', 'SUSPENDED', 'REVOKED' (default: 'ACTIVE') |
| `metadata` | JSONB | NULL | Additional client configuration (JSONB for flexible schema) - stores `bap_id`, `bap_uri`, `rate_limit` |
| `created_at` | TIMESTAMP | NOT NULL | Timestamp when client was first created (immutable) |
| `updated_at` | TIMESTAMP | NOT NULL | Timestamp when client was last updated (updated on UPSERT) |
| `last_synced_at` | TIMESTAMP | NOT NULL | Timestamp when client was last synced from Admin Service (updated on UPSERT) |

**Indexes:**
```sql
CREATE INDEX IF NOT EXISTS idx_client_registry_client_id ON client_registry.clients(client_id);
CREATE INDEX IF NOT EXISTS idx_client_registry_status ON client_registry.clients(status);
CREATE INDEX IF NOT EXISTS idx_client_registry_client_code ON client_registry.clients(client_code);
CREATE INDEX IF NOT EXISTS idx_client_registry_bap_id ON client_registry.clients(bap_id);
```

**Usage Pattern:**
- **Write:** Event consumer (`client_event_consumer.go`) upserts clients on `client.*` events from Admin Service
- **Read:** Client authentication service (`client_auth_service.go`) looks up clients for runtime validation
- **Sync Mechanism:** Event-driven (Redis Streams: `stream:admin.client.events`), not direct DB queries
- **Retention:** Permanent (synced from Admin Service), 5 min cache TTL in Redis

**UPSERT Behavior:**
- Uses `ON CONFLICT (client_id) DO UPDATE` to handle idempotent event replay
- Updates: `client_code`, `client_secret_hash`, `api_key_hash`, `bap_id`, `bap_uri`, `allowed_ips`, `rate_limit`, `status`, `metadata`, `updated_at`, `last_synced_at`
- Does NOT update: `id`, `client_id`, `created_at`

**Metadata JSONB Structure:**
```json
{
  "bap_id": "buyer.example.com",
  "bap_uri": "https://buyer.example.com/ondc",
  "rate_limit": 100
}
```

---

## 3. ONDC Reference Schema (`ondc_reference`)

### 3.1 `ondc_reference.order_mapping`

**Purpose:** Order reference mappings for ID correlation (currently used for DB storage, code uses Redis for hot-path lookups)

**Table Definition:**
```sql
CREATE SCHEMA IF NOT EXISTS ondc_reference;

CREATE TABLE IF NOT EXISTS ondc_reference.order_mapping (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    search_id UUID,
    quote_id UUID,
    order_id VARCHAR(255),
    dispatch_order_id VARCHAR(255),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);
```

**Field Descriptions:**

| Field | Type | Nullable | Description |
|-------|------|----------|-------------|
| `id` | UUID | NOT NULL | Primary key, internal database identifier (auto-generated) |
| `search_id` | UUID | NULL | Serviceability ID (generated by UOIS Gateway during `/search` flow) |
| `quote_id` | UUID | NULL | Quote ID (generated by Order Service during `/init` flow) |
| `order_id` | VARCHAR(255) | NULL | ONDC order.id (seller-generated, network-facing) - sent in `/on_confirm` callback |
| `dispatch_order_id` | VARCHAR(255) | NULL | Internal Order Service identifier (internal-only, never sent in ONDC payloads) |
| `created_at` | TIMESTAMP | NOT NULL | Timestamp when mapping was created (immutable, set by database DEFAULT) |

**Indexes:**
```sql
CREATE INDEX IF NOT EXISTS idx_order_mapping_search_id ON ondc_reference.order_mapping(search_id);
CREATE INDEX IF NOT EXISTS idx_order_mapping_quote_id ON ondc_reference.order_mapping(quote_id);
CREATE INDEX IF NOT EXISTS idx_order_mapping_order_id ON ondc_reference.order_mapping(order_id);
CREATE INDEX IF NOT EXISTS idx_order_mapping_dispatch_order_id ON ondc_reference.order_mapping(dispatch_order_id);
```

**Usage Pattern:**
- **Current Implementation:** Code uses Redis for hot-path lookups (fast, sub-millisecond latency)
- **DB Storage:** Table exists for future migration or audit purposes
- **Retention:** 7 years (audit), 30 days (cache in Redis)

**Note on Implementation:**
- **Code Location:** `internal/repository/order_record/order_record_repository.go` uses Redis keys, not DB table
- **Redis Keys:** `{prefix}:order_record:search_id:{search_id}`, `{prefix}:order_record:quote_id:{quote_id}`, `{prefix}:order_record:order_id:{client_id}:{order_id}`, `{prefix}:order_record:transaction_id:{transaction_id}`
- **OrderRecord Struct:** The Go struct (`internal/handlers/ondc/interfaces.go`) includes additional fields not in DB table:
  - `ClientID` (string) - Stored in Redis key for `order_id` lookup: `order_id:{client_id}:{order_id}`
  - `TransactionID` (string) - Stored in Redis for `/init` correlation lookup
  - `MessageID` (string) - Stored in Redis for idempotency
  - `FulfillmentID` (string) - Stored in Redis (ONDC-visible, stable per order)
- **Future Migration:** Code may be updated to use DB table for persistence, with Redis as cache layer. If migrated, DB table should include: `client_id`, `transaction_id`, `message_id`, `fulfillment_id` fields

**Note on Missing Fields (FR vs Implementation):**
The FR document (Section 10.3.2) mentions additional fields that are **not currently implemented**:
- `reference_id` (PK, UUID) - **Not implemented** (using `id` instead)
- `client_id` (FK) - **Not implemented** (stored in Redis key: `order_id:{client_id}:{order_id}`)
- `protocol_type` (enum: 'ONDC', 'BECKN') - **Not implemented**
- `request_id` (FK to audit log) - **Not implemented**

These fields may be added in future migrations if required for enhanced order reference tracking.

---

## Database Connection Configuration

**Environment Variables:**
- `POSTGRES_E_HOST` - Database host (required)
- `POSTGRES_E_PORT` - Database port (required, default: 5432)
- `POSTGRES_E_USER` - Database user (required)
- `POSTGRES_E_PASSWORD` - Database password (required)
- `POSTGRES_E_DB` - Database name (required, e.g., "postgres_audit" or "postgres_e")
- `POSTGRES_E_SSLMODE` - SSL mode (optional, default: "disable")

**Connection String Format:**
```
postgres://{user}:{password}@{host}:{port}/{db}?sslmode={sslmode}
```

**Connection Initialization:**
- Location: `cmd/server/main.go` (lines 59-71)
- Connection tested via `db.Ping()` on startup
- Fail-fast: Application does not start if database connection fails

---

## Data Retention & Archival

**Retention Policies:**

| Schema/Table | Retention Period | Archival Strategy |
|--------------|-----------------|-------------------|
| `audit.request_response_logs` | 7 years minimum | Monthly snapshots archived to S3 |
| `audit.callback_delivery_logs` | 7 years minimum | Monthly snapshots archived to S3 |
| `client_registry.clients` | Permanent (synced from Admin Service) | No archival (operational data) |
| `ondc_reference.order_mapping` | 7 years (audit), 30 days (cache) | Monthly snapshots archived to S3 |

**Backup Strategy:**
- **Daily Snapshots:** 7-day PITR window for operational recovery
- **Monthly Snapshots:** Archived to S3 (7-year retention for compliance)
- **Automated Archival:** Logs older than 1 year automatically archived to S3

**RTO/RPO:**
- **RTO (Recovery Time Objective):** 30 minutes
- **RPO (Recovery Point Objective):** 1 hour

---

## Security & Access Control

**Access Pattern:**
- **Write:** UOIS Gateway only (append-only, immutable logs)
- **Read:** Admin Dashboard (dispute resolution), Analytics Service (metrics)
- **No Updates/Deletes:** Database constraints prevent modification

**Security Isolation:**
- **Separate Database Instance:** Complete isolation from other services (Postgres-A/B/C/D)
- **Separate VPC Security Groups:** Network-level isolation
- **Separate IAM Roles:** Access control isolation
- **Separate Encryption Keys:** Data encryption isolation

**Tamper Resistance:**
- **Immutable Logs:** Append-only (no updates/deletes)
- **Database Constraints:** Prevent modification
- **Audit Trail:** Complete request/response pairs for dispute resolution

---

## Migration Files

**Migration Execution Order:**
1. `001_create_audit_schema.sql` - Creates `audit` schema and tables
2. `002_create_client_registry_schema.sql` - Creates `client_registry` schema and tables
3. `003_create_ondc_reference_schema.sql` - Creates `ondc_reference` schema and tables

**Migration Location:** `migrations/` directory

**Migration Execution:**
- Run migrations in order before application startup
- Use database migration tool (e.g., `golang-migrate`, `flyway`, manual SQL execution)
- Verify migrations succeed before deploying application

---

## Schema Version History

| Version | Date | Description |
|---------|------|-------------|
| 1.0.0 | January 2025 | Initial schema creation (audit, client_registry, ondc_reference) |

---

## Future Enhancements

**Potential Schema Additions:**

1. **Enhanced Audit Logging:**
   - Add `request_hash`, `signature`, `nonce`, `source_ip` fields to `audit.request_response_logs`
   - Add `protocol_type`, `status_code`, `error_code`, `environment` fields
   - Add `traceparent` field (full W3C traceparent header, not just extracted `trace_id`)

2. **Enhanced Callback Delivery Logging:**
   - Add `response_code`, `response_body`, `retry_count`, `next_retry_at`, `delivered_at` fields
   - Add foreign key relationship to `audit.request_response_logs`

3. **Enhanced Order Reference:**
   - Add `client_id`, `protocol_type`, `request_id` (FK) fields to `ondc_reference.order_mapping`
   - Add `updated_at` timestamp for tracking reference updates

4. **IGM (Issue & Grievance Management) Tables:**
   - Add `igm.issues` table for IGM issue storage (currently stored in Redis)
   - Add `igm.issue_status_history` table for issue lifecycle tracking

---

## Related Documentation

- **Functional Requirements:** `docs/production-docs/UOISGateway_FR.md` (Section 10: Data Ownership & Storage)
- **Implementation Log:** `docs/implementation-plans/SETUP_LOG.md`
- **Migration Files:** `migrations/001_create_audit_schema.sql`, `migrations/002_create_client_registry_schema.sql`, `migrations/003_create_ondc_reference_schema.sql`
- **Repository Code:** `internal/repository/audit/`, `internal/repository/client_registry/`, `internal/repository/order_record/`

---

**Document Version:** 1.0.0  
**Last Updated:** January 2025  
**Maintained By:** UOIS Gateway Team

